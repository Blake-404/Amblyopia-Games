<!doctype html>
<html>
  <head><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geologica:wght@100;400;700;900&display=swap" rel="stylesheet">
  </head>

  <body>

    <div id="brickbreak">
        <div id="gameMarginTop"></div>
        <div id="game">
            <div id="boxGrid"></div>
            <div id="paddle"></div>
        </div>   
        <div id="gameMarginBottom"></div>     
    </div>


    <style>
        #game {
            width: 500px;
            height: 500px;
            position: relative;
        }

        #ball {
            position: absolute;
            /* left: 300px;
            top: 300px; */
            height: 20px;
            width: 20px;
            background-color: red;
            
        }

        #paddle {
            position: absolute;
            background-color: blue;
            left: 100px;
            height: 15px;
            width: 80px;
            bottom: 20px;
        }

        #boxGrid > div {
            position: absolute;
            width: 15px;
            height: 10px;
            background-color: blue;
            /* flex-basis: 6%; */
            /* margin: 2px 2px 2px 2px; */
        }

        #boxGrid {
            /* display: flex;
            flex-wrap: wrap; */
            margin-left: 10px;
        }
        
    </style>

    <script>
        // key listeners

        let gridItemBounds = [];
        let gridSize = [500, 500];

        class Ball {
            constructor() {
                this.diam = "15px";
                this.position = { x: 300, y: 300 };
                this.dir = { x: -1, y: +1 };
                this.newBall();
            }

            newBall = () => {
                let game = document.getElementById('game');
                const newBall = document.createElement('div')
                newBall.setAttribute('id', 'ball');
                newBall.style.left = "300px";
                newBall.style.top = "300px";
                let text = document.createTextNode('');
                newBall.appendChild(text);
                game.appendChild(newBall);
            }

            ballMovement = (x, y) => {
                let ball = document.getElementById('ball');
                let xCurr = parseInt(ball.style.left);
                let yCurr = parseInt(ball.style.top);
                let new_x = (xCurr += x) + "px";
                let new_y = (yCurr += y) + "px";
                ball.style.left = new_x;
                ball.style.top = new_y;
            }

            clearGridItem = () => {

            }

            changeDirection(delta=undefined) {
                if (delta != undefined) {
                    // do stuff ...???????
                }
                if (this.dir['x'] === -1 && this.dir['y'] === +1 ) {
                    this.dir['x'] = -1;
                    this.dir['y'] = -1;
                } else if (this.dir['x'] === -1 && this.dir['y'] === -1) {
                    this.dir['x'] = +1;
                    this.dir['y'] = -1;
                } else if (this.dir['x'] === +1 && this.dir['y'] === -1) {
                    this.dir['x'] = +1;
                    this.dir['y'] = +1;
                } else if (this.dir['x'] === +1 && this.dir['y'] === +1) {
                    this.dir['x'] = -1;
                    this.dir['y'] = +1;
                }
            }
        
            checkBounds = () => {
                let ball = document.getElementById('ball');
                let paddle = document.getElementById('paddle');
                ball.bounding = ball.getBoundingClientRect();
                paddle.bounding = paddle.getBoundingClientRect();

                console.log(
                    "check " + ball.bounding + 
                    " againt " + paddle.bounding +
                    " and these:"
                )

                // getBoundingClientRect() = 

                // make checks for each side of the ball

                // if bottom of ball matches top of paddle, change direction
                if (ball.bounding.bottom === paddle.bounding.top) {
                    // console.log("test teste")
                    this.changeDirection();
                }
                        // if left of ball matches right of paddle...

                        // if right of ball matdhes left of paddle...

                            // make it bounce
                // if left side of ball less than 0, right side more than game width, top of ball less than 0
                if (ball.bounding.left <= 0 || ball.bounding.top <= 0 || ball.bounding.right >= gridSize[0]) {
                    // console.log("wall bounce");
                    this.changeDirection();
                }
                        // make it bounce
                // if bottom of ball more than game height
                        // new ball or game over
                // go through global griditems bounds array and check if 
                for (let i = 0; i < gridItemBounds.length; i++) {
                    // console.log(gridItemBounds[i])
                    if (ball.bounding.top === gridItemBounds[i].bottom &&
                        ball.bounding.left > gridItemBounds[i].left &&
                        ball.bounding.right < gridItemBounds[i].right) {
                        console.log("hit on " + i + " block")
                        this.changeDirection();
                    } else if (ball.bounding.left === gridItemBounds[i].right ) {
                    // left of ball matches right of grid item 
                        // this.changeDirection();
                    } else if (ball.bounding.right === gridItemBounds[i].left) {
                    // right of ball matches left of grid item
                        // this.changeDirection();
                    } else if (ball.bounding.bottom === gridItemBounds[i].top) {
                    // bottom of ball matches top of grid item
                        // this.changeDirection();
                    }
                }

                        // if match
                            // bounce ball in appropriate directions
                            // remove grid item from game
                            // add appropriate amount of points

                // console.log("check")
                // console.log(ball.bounding)
                // console.log("against")
                // console.log(paddle.bounding)
                // console.log(gridItemBounds)
            }
        }

        class Brickbreak {
            constructor() {
                this.height = 500;
                this.width = 500;
                this.gameStatus = true;
                this.grid = document.getElementById('boxGrid');
            }
        
            buildGridCells = () => {
                let topOffset = 0;
                let leftOffset = 0;

                for (let i = 0; i < 80; i++) {

                    let gridItem = document.createElement('div');
                    gridItem.setAttribute('id', i);
                    let text = document.createTextNode('');
                    gridItem.appendChild(text);
                    gridItem.style.width = "40px";
                    gridItem.style.height = "12px";
                    let leftOffsetAmt = parseInt(gridItem.style.width) + 10;
                    leftOffset += leftOffsetAmt

                    if (i % 10 === 0) {
                        let topOffsetAmt = 18;
                        topOffset = (i / 10) * topOffsetAmt;
                        leftOffset = 0;
                    }

                    gridItem.style.top = topOffset + "px";
                    gridItem.style.left = leftOffset + "px"
                    this.grid.appendChild(gridItem)
                    
                    gridItemBounds.push(gridItem.getBoundingClientRect());

                }
            }
        }

        class Controller {
            constructor() {
                this.score = 0;
                this.level = 1;
                this.tickDelay = 15;
                this.game = new Brickbreak();
                this.ball = new Ball();
            }

            eachTick = () => {
                this.ball.ballMovement(this.ball.dir['x'], this.ball.dir['y']);
                this.ball.checkBounds();
                setTimeout(this.eachTick, this.tickDelay);
            }

            initGame = () => {
                this.game.buildGridCells();
                this.eachTick();
            }
        }

        window.onload = function() {    
            const ctrl = new Controller()                                                                                                                                                                                                                                                                                                                                                                                                                           
            ctrl.initGame();
            console.log("onload");
        }
        
        </script> 
    </body>
</html>